// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License. See LICENSE in the project root for license information.
// Code generated by Microsoft (R) AutoRest Code Generator.
// Changes may cause incorrect behavior and will be lost if the code is regenerated.
// SPDX-License-Identifier: MIT

package realtimeintelligence_test

import (
	"context"
	"net/http"
	"testing"

	"github.com/Azure/azure-sdk-for-go/sdk/azcore"

	azfake "github.com/Azure/azure-sdk-for-go/sdk/azcore/fake"
	"github.com/Azure/azure-sdk-for-go/sdk/azcore/runtime"
	"github.com/Azure/azure-sdk-for-go/sdk/azcore/to"

	"reflect"

	"github.com/stretchr/testify/suite"

	"github.com/microsoft/fabric-sdk-go/fabric"
	"github.com/microsoft/fabric-sdk-go/fabric/realtimeintelligence"
	"github.com/microsoft/fabric-sdk-go/fabric/realtimeintelligence/fake"
)

var err error

type FakeTestSuite struct {
	suite.Suite

	ctx  context.Context
	cred azcore.TokenCredential

	serverFactory *fake.ServerFactory
	clientFactory *realtimeintelligence.ClientFactory
}

func (testsuite *FakeTestSuite) SetupSuite() {
	testsuite.ctx = context.Background()
	testsuite.cred = &azfake.TokenCredential{}

	testsuite.serverFactory = &fake.ServerFactory{}
	testsuite.clientFactory, err = realtimeintelligence.NewClientFactory(testsuite.cred, nil, &fabric.ClientOptions{
		ClientOptions: azcore.ClientOptions{
			Transport: fake.NewServerFactoryTransport(testsuite.serverFactory),
		},
	})
	testsuite.Require().NoError(err, "Failed to create client factory")
}

func TestFakeTest(t *testing.T) {
	suite.Run(t, new(FakeTestSuite))
}

func (testsuite *FakeTestSuite) TestCopilot_NLToKQLBeta() {
	// From example
	ctx := runtime.WithHTTPHeader(testsuite.ctx, map[string][]string{
		"example-id": {"NlToKql example"},
	})
	var exampleWorkspaceID string
	var exampleBeta bool
	var exampleNlToKqlRequest realtimeintelligence.NlToKqlRequest
	exampleWorkspaceID = "cfafbeb1-8037-4d0c-896e-a46fb27ff229"
	exampleBeta = true
	exampleNlToKqlRequest = realtimeintelligence.NlToKqlRequest{
		ClusterURL:       to.Ptr("https://trd-2cucrmayps3jqfwk92.z9.kusto.fabric.microsoft.com"),
		DatabaseName:     to.Ptr("b74e4636-0f20-4368-8cc1-a5a1003252af"),
		ItemIDForBilling: to.Ptr("5b218778-e7a5-4d73-8187-f10824047715"),
		NaturalLanguage:  to.Ptr("Generate a query for counting records in the Products table"),
	}

	exampleRes := realtimeintelligence.NlToKqlResponse{
		KqlQuery: to.Ptr("Products | count"),
	}

	testsuite.serverFactory.CopilotServer.NLToKQLBeta = func(ctx context.Context, workspaceID string, beta bool, nlToKqlRequest realtimeintelligence.NlToKqlRequest, options *realtimeintelligence.CopilotClientNLToKQLBetaOptions) (resp azfake.Responder[realtimeintelligence.CopilotClientNLToKQLBetaResponse], errResp azfake.ErrorResponder) {
		testsuite.Require().Equal(exampleWorkspaceID, workspaceID)
		testsuite.Require().Equal(exampleBeta, beta)
		testsuite.Require().True(reflect.DeepEqual(exampleNlToKqlRequest, nlToKqlRequest))
		resp = azfake.Responder[realtimeintelligence.CopilotClientNLToKQLBetaResponse]{}
		resp.SetResponse(http.StatusOK, realtimeintelligence.CopilotClientNLToKQLBetaResponse{NlToKqlResponse: exampleRes}, nil)
		return
	}

	client := testsuite.clientFactory.NewCopilotClient()
	res, err := client.NLToKQLBeta(ctx, exampleWorkspaceID, exampleBeta, exampleNlToKqlRequest, nil)
	testsuite.Require().NoError(err, "Failed to get result for example ")
	testsuite.Require().True(reflect.DeepEqual(exampleRes, res.NlToKqlResponse))
}
