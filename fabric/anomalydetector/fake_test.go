// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License. See LICENSE in the project root for license information.
// Code generated by Microsoft (R) AutoRest Code Generator.
// Changes may cause incorrect behavior and will be lost if the code is regenerated.
// SPDX-License-Identifier: MIT

package anomalydetector_test

import (
	"context"
	"net/http"
	"testing"

	"github.com/Azure/azure-sdk-for-go/sdk/azcore"

	azfake "github.com/Azure/azure-sdk-for-go/sdk/azcore/fake"
	"github.com/Azure/azure-sdk-for-go/sdk/azcore/runtime"
	"github.com/Azure/azure-sdk-for-go/sdk/azcore/to"

	"reflect"

	"github.com/stretchr/testify/suite"

	"github.com/microsoft/fabric-sdk-go/fabric"
	"github.com/microsoft/fabric-sdk-go/fabric/anomalydetector"
	"github.com/microsoft/fabric-sdk-go/fabric/anomalydetector/fake"
)

var err error

type FakeTestSuite struct {
	suite.Suite

	ctx  context.Context
	cred azcore.TokenCredential

	serverFactory *fake.ServerFactory
	clientFactory *anomalydetector.ClientFactory
}

func (testsuite *FakeTestSuite) SetupSuite() {
	testsuite.ctx = context.Background()
	testsuite.cred = &azfake.TokenCredential{}

	testsuite.serverFactory = &fake.ServerFactory{}
	testsuite.clientFactory, err = anomalydetector.NewClientFactory(testsuite.cred, nil, &fabric.ClientOptions{
		ClientOptions: azcore.ClientOptions{
			Transport: fake.NewServerFactoryTransport(testsuite.serverFactory),
		},
	})
	testsuite.Require().NoError(err, "Failed to create client factory")
}

func TestFakeTest(t *testing.T) {
	suite.Run(t, new(FakeTestSuite))
}

func (testsuite *FakeTestSuite) TestItems_ListAnomalyDetectors() {
	// From example
	ctx := runtime.WithHTTPHeader(testsuite.ctx, map[string][]string{
		"example-id": {"List AnomalyDetectors in workspace example"},
	})
	var exampleWorkspaceID string
	exampleWorkspaceID = "cfafbeb1-8037-4d0c-896e-a46fb27ff229"

	exampleRes := anomalydetector.AnomalyDetectors{
		Value: []anomalydetector.AnomalyDetector{
			{
				Type:        to.Ptr(anomalydetector.ItemTypeAnomalyDetector),
				Description: to.Ptr("A AnomalyDetector description."),
				DisplayName: to.Ptr("AnomalyDetector Name 1"),
				ID:          to.Ptr("3546052c-ae64-4526-b1a8-52af7761426f"),
				WorkspaceID: to.Ptr("cfafbeb1-8037-4d0c-896e-a46fb27ff229"),
				Properties: &anomalydetector.Properties{
					OneLakeRootPath: to.Ptr("https://onelake.dfs.fabric.microsoft.com/f089354e-8366-4e18-aea3-4cb4a3a50b48/41ce06d1-d81b-4ea0-bc6d-2ce3dd2f8e87"),
				},
			},
			{
				Type:        to.Ptr(anomalydetector.ItemTypeAnomalyDetector),
				Description: to.Ptr("A AnomalyDetector description."),
				DisplayName: to.Ptr("AnomalyDetector Name 2"),
				ID:          to.Ptr("f697fb63-abd4-4399-9548-be7e3c3c0dac"),
				WorkspaceID: to.Ptr("cfafbeb1-8037-4d0c-896e-a46fb27ff229"),
				Properties: &anomalydetector.Properties{
					OneLakeRootPath: to.Ptr("https://onelake.dfs.fabric.microsoft.com/f089354e-8366-4e18-aea3-4cb4a3a50b48/d8f6cf16-3aac-4440-9d76-a03d86b7ae3e"),
				},
			}},
	}

	testsuite.serverFactory.ItemsServer.NewListAnomalyDetectorsPager = func(workspaceID string, options *anomalydetector.ItemsClientListAnomalyDetectorsOptions) (resp azfake.PagerResponder[anomalydetector.ItemsClientListAnomalyDetectorsResponse]) {
		testsuite.Require().Equal(exampleWorkspaceID, workspaceID)
		resp = azfake.PagerResponder[anomalydetector.ItemsClientListAnomalyDetectorsResponse]{}
		resp.AddPage(http.StatusOK, anomalydetector.ItemsClientListAnomalyDetectorsResponse{AnomalyDetectors: exampleRes}, nil)
		return
	}

	client := testsuite.clientFactory.NewItemsClient()
	pager := client.NewListAnomalyDetectorsPager(exampleWorkspaceID, &anomalydetector.ItemsClientListAnomalyDetectorsOptions{ContinuationToken: nil})
	for pager.More() {
		nextResult, err := pager.NextPage(ctx)
		testsuite.Require().NoError(err, "Failed to advance page for example ")
		testsuite.Require().True(reflect.DeepEqual(exampleRes, nextResult.AnomalyDetectors))
		if err == nil {
			break
		}
	}
}

func (testsuite *FakeTestSuite) TestItems_CreateAnomalyDetector() {
	// From example
	ctx := runtime.WithHTTPHeader(testsuite.ctx, map[string][]string{
		"example-id": {"Create a AnomalyDetector example"},
	})
	var exampleWorkspaceID string
	var exampleCreateAnomalyDetectorRequest anomalydetector.CreateAnomalyDetectorRequest
	exampleWorkspaceID = "cfafbeb1-8037-4d0c-896e-a46fb27ff229"
	exampleCreateAnomalyDetectorRequest = anomalydetector.CreateAnomalyDetectorRequest{
		Description: to.Ptr("A AnomalyDetector description."),
		DisplayName: to.Ptr("AnomalyDetector 1"),
	}

	testsuite.serverFactory.ItemsServer.BeginCreateAnomalyDetector = func(ctx context.Context, workspaceID string, createAnomalyDetectorRequest anomalydetector.CreateAnomalyDetectorRequest, options *anomalydetector.ItemsClientBeginCreateAnomalyDetectorOptions) (resp azfake.PollerResponder[anomalydetector.ItemsClientCreateAnomalyDetectorResponse], errResp azfake.ErrorResponder) {
		testsuite.Require().Equal(exampleWorkspaceID, workspaceID)
		testsuite.Require().True(reflect.DeepEqual(exampleCreateAnomalyDetectorRequest, createAnomalyDetectorRequest))
		resp = azfake.PollerResponder[anomalydetector.ItemsClientCreateAnomalyDetectorResponse]{}
		resp.SetTerminalResponse(http.StatusCreated, anomalydetector.ItemsClientCreateAnomalyDetectorResponse{}, nil)
		return
	}

	client := testsuite.clientFactory.NewItemsClient()
	poller, err := client.BeginCreateAnomalyDetector(ctx, exampleWorkspaceID, exampleCreateAnomalyDetectorRequest, nil)
	testsuite.Require().NoError(err, "Failed to get result for example ")
	_, err = poller.PollUntilDone(ctx, nil)
	testsuite.Require().NoError(err, "Failed to get LRO result for example ")

	// From example
	ctx = runtime.WithHTTPHeader(testsuite.ctx, map[string][]string{
		"example-id": {"Create a AnomalyDetector with definition example"},
	})
	exampleWorkspaceID = "cfafbeb1-8037-4d0c-896e-a46fb27ff229"
	exampleCreateAnomalyDetectorRequest = anomalydetector.CreateAnomalyDetectorRequest{
		Description: to.Ptr("A AnomalyDetector description."),
		Definition: &anomalydetector.Definition{
			Format: to.Ptr(anomalydetector.DefinitionFormatAnomalyDetectorV1),
			Parts: []anomalydetector.DefinitionPart{
				{
					Path:        to.Ptr("Configurations.json"),
					Payload:     to.Ptr("eyANCiAgIiRpZCI6ICJodHRwczovL2RldmVsb3Blci5taWNyb3NvZnQuY29tL2pzb24tc2NoZW1hcy9mYWJyaWMvaXRlbS9hbm9tYWx5RGV0ZWN0b3IvZGVmaW5pdGlvbi8xLjAuMC9zY2hlbWEuanNvbiIsDQogICIkc2NoZW1hIjogImh0dHBzOi8vanNvbi1zY2hlbWEub3JnL2RyYWZ0LTA3L3NjaGVtYSMiLA0KICAidW5pdmFyaWF0ZUNvbmZpZ3VyYXRpb25zIjogWw0KICBdDQp9"),
					PayloadType: to.Ptr(anomalydetector.PayloadTypeInlineBase64),
				},
				{
					Path:        to.Ptr(".platform"),
					Payload:     to.Ptr("ZG90UGxhdGZvcm1CYXNlNjRTdHJpbmc="),
					PayloadType: to.Ptr(anomalydetector.PayloadTypeInlineBase64),
				}},
		},
		DisplayName: to.Ptr("AnomalyDetector 1"),
	}

	testsuite.serverFactory.ItemsServer.BeginCreateAnomalyDetector = func(ctx context.Context, workspaceID string, createAnomalyDetectorRequest anomalydetector.CreateAnomalyDetectorRequest, options *anomalydetector.ItemsClientBeginCreateAnomalyDetectorOptions) (resp azfake.PollerResponder[anomalydetector.ItemsClientCreateAnomalyDetectorResponse], errResp azfake.ErrorResponder) {
		testsuite.Require().Equal(exampleWorkspaceID, workspaceID)
		testsuite.Require().True(reflect.DeepEqual(exampleCreateAnomalyDetectorRequest, createAnomalyDetectorRequest))
		resp = azfake.PollerResponder[anomalydetector.ItemsClientCreateAnomalyDetectorResponse]{}
		resp.SetTerminalResponse(http.StatusCreated, anomalydetector.ItemsClientCreateAnomalyDetectorResponse{}, nil)
		return
	}

	poller, err = client.BeginCreateAnomalyDetector(ctx, exampleWorkspaceID, exampleCreateAnomalyDetectorRequest, nil)
	testsuite.Require().NoError(err, "Failed to get result for example ")
	_, err = poller.PollUntilDone(ctx, nil)
	testsuite.Require().NoError(err, "Failed to get LRO result for example ")
}

func (testsuite *FakeTestSuite) TestItems_GetAnomalyDetector() {
	// From example
	ctx := runtime.WithHTTPHeader(testsuite.ctx, map[string][]string{
		"example-id": {"Get a AnomalyDetector example"},
	})
	var exampleWorkspaceID string
	var exampleAnomalyDetectorID string
	exampleWorkspaceID = "f089354e-8366-4e18-aea3-4cb4a3a50b48"
	exampleAnomalyDetectorID = "41ce06d1-d81b-4ea0-bc6d-2ce3dd2f8e87"

	exampleRes := anomalydetector.AnomalyDetector{
		Type:        to.Ptr(anomalydetector.ItemTypeAnomalyDetector),
		Description: to.Ptr("A AnomalyDetector description."),
		DisplayName: to.Ptr("AnomalyDetector 1"),
		ID:          to.Ptr("5b218778-e7a5-4d73-8187-f10824047715"),
		WorkspaceID: to.Ptr("cfafbeb1-8037-4d0c-896e-a46fb27ff229"),
		Properties: &anomalydetector.Properties{
			OneLakeRootPath: to.Ptr("https://onelake.dfs.fabric.microsoft.com/f089354e-8366-4e18-aea3-4cb4a3a50b48/41ce06d1-d81b-4ea0-bc6d-2ce3dd2f8e87"),
		},
	}

	testsuite.serverFactory.ItemsServer.GetAnomalyDetector = func(ctx context.Context, workspaceID string, anomalyDetectorID string, options *anomalydetector.ItemsClientGetAnomalyDetectorOptions) (resp azfake.Responder[anomalydetector.ItemsClientGetAnomalyDetectorResponse], errResp azfake.ErrorResponder) {
		testsuite.Require().Equal(exampleWorkspaceID, workspaceID)
		testsuite.Require().Equal(exampleAnomalyDetectorID, anomalyDetectorID)
		resp = azfake.Responder[anomalydetector.ItemsClientGetAnomalyDetectorResponse]{}
		resp.SetResponse(http.StatusOK, anomalydetector.ItemsClientGetAnomalyDetectorResponse{AnomalyDetector: exampleRes}, nil)
		return
	}

	client := testsuite.clientFactory.NewItemsClient()
	res, err := client.GetAnomalyDetector(ctx, exampleWorkspaceID, exampleAnomalyDetectorID, nil)
	testsuite.Require().NoError(err, "Failed to get result for example ")
	testsuite.Require().True(reflect.DeepEqual(exampleRes, res.AnomalyDetector))
}

func (testsuite *FakeTestSuite) TestItems_UpdateAnomalyDetector() {
	// From example
	ctx := runtime.WithHTTPHeader(testsuite.ctx, map[string][]string{
		"example-id": {"Update a AnomalyDetector example"},
	})
	var exampleWorkspaceID string
	var exampleAnomalyDetectorID string
	var exampleUpdateAnomalyDetectorRequest anomalydetector.UpdateAnomalyDetectorRequest
	exampleWorkspaceID = "cfafbeb1-8037-4d0c-896e-a46fb27ff229"
	exampleAnomalyDetectorID = "5b218778-e7a5-4d73-8187-f10824047715"
	exampleUpdateAnomalyDetectorRequest = anomalydetector.UpdateAnomalyDetectorRequest{
		Description: to.Ptr("AnomalyDetector's New description"),
		DisplayName: to.Ptr("AnomalyDetector's New name"),
	}

	exampleRes := anomalydetector.AnomalyDetector{
		Type:        to.Ptr(anomalydetector.ItemTypeAnomalyDetector),
		Description: to.Ptr("AnomalyDetector's New description"),
		DisplayName: to.Ptr("AnomalyDetector's New name"),
		ID:          to.Ptr("5b218778-e7a5-4d73-8187-f10824047715"),
		WorkspaceID: to.Ptr("cfafbeb1-8037-4d0c-896e-a46fb27ff229"),
	}

	testsuite.serverFactory.ItemsServer.UpdateAnomalyDetector = func(ctx context.Context, workspaceID string, anomalyDetectorID string, updateAnomalyDetectorRequest anomalydetector.UpdateAnomalyDetectorRequest, options *anomalydetector.ItemsClientUpdateAnomalyDetectorOptions) (resp azfake.Responder[anomalydetector.ItemsClientUpdateAnomalyDetectorResponse], errResp azfake.ErrorResponder) {
		testsuite.Require().Equal(exampleWorkspaceID, workspaceID)
		testsuite.Require().Equal(exampleAnomalyDetectorID, anomalyDetectorID)
		testsuite.Require().True(reflect.DeepEqual(exampleUpdateAnomalyDetectorRequest, updateAnomalyDetectorRequest))
		resp = azfake.Responder[anomalydetector.ItemsClientUpdateAnomalyDetectorResponse]{}
		resp.SetResponse(http.StatusOK, anomalydetector.ItemsClientUpdateAnomalyDetectorResponse{AnomalyDetector: exampleRes}, nil)
		return
	}

	client := testsuite.clientFactory.NewItemsClient()
	res, err := client.UpdateAnomalyDetector(ctx, exampleWorkspaceID, exampleAnomalyDetectorID, exampleUpdateAnomalyDetectorRequest, nil)
	testsuite.Require().NoError(err, "Failed to get result for example ")
	testsuite.Require().True(reflect.DeepEqual(exampleRes, res.AnomalyDetector))
}

func (testsuite *FakeTestSuite) TestItems_DeleteAnomalyDetector() {
	// From example
	ctx := runtime.WithHTTPHeader(testsuite.ctx, map[string][]string{
		"example-id": {"Delete a AnomalyDetector example"},
	})
	var exampleWorkspaceID string
	var exampleAnomalyDetectorID string
	exampleWorkspaceID = "cfafbeb1-8037-4d0c-896e-a46fb27ff229"
	exampleAnomalyDetectorID = "5b218778-e7a5-4d73-8187-f10824047715"

	testsuite.serverFactory.ItemsServer.DeleteAnomalyDetector = func(ctx context.Context, workspaceID string, anomalyDetectorID string, options *anomalydetector.ItemsClientDeleteAnomalyDetectorOptions) (resp azfake.Responder[anomalydetector.ItemsClientDeleteAnomalyDetectorResponse], errResp azfake.ErrorResponder) {
		testsuite.Require().Equal(exampleWorkspaceID, workspaceID)
		testsuite.Require().Equal(exampleAnomalyDetectorID, anomalyDetectorID)
		resp = azfake.Responder[anomalydetector.ItemsClientDeleteAnomalyDetectorResponse]{}
		resp.SetResponse(http.StatusOK, anomalydetector.ItemsClientDeleteAnomalyDetectorResponse{}, nil)
		return
	}

	client := testsuite.clientFactory.NewItemsClient()
	_, err = client.DeleteAnomalyDetector(ctx, exampleWorkspaceID, exampleAnomalyDetectorID, nil)
	testsuite.Require().NoError(err, "Failed to get result for example ")
}

func (testsuite *FakeTestSuite) TestItems_GetAnomalyDetectorDefinition() {
	// From example
	ctx := runtime.WithHTTPHeader(testsuite.ctx, map[string][]string{
		"example-id": {"Get a AnomalyDetector definition example"},
	})
	var exampleWorkspaceID string
	var exampleAnomalyDetectorID string
	exampleWorkspaceID = "6e335e92-a2a2-4b5a-970a-bd6a89fbb765"
	exampleAnomalyDetectorID = "cfafbeb1-8037-4d0c-896e-a46fb27ff229"

	exampleRes := anomalydetector.DefinitionResponse{
		Definition: &anomalydetector.Definition{
			Format: to.Ptr(anomalydetector.DefinitionFormatAnomalyDetectorV1),
			Parts: []anomalydetector.DefinitionPart{
				{
					Path:        to.Ptr("Configurations.json"),
					Payload:     to.Ptr("eyANCiAgIiRpZCI6ICJodHRwczovL2RldmVsb3Blci5taWNyb3NvZnQuY29tL2pzb24tc2NoZW1hcy9mYWJyaWMvaXRlbS9hbm9tYWx5RGV0ZWN0b3IvZGVmaW5pdGlvbi8xLjAuMC9zY2hlbWEuanNvbiIsDQogICIkc2NoZW1hIjogImh0dHBzOi8vanNvbi1zY2hlbWEub3JnL2RyYWZ0LTA3L3NjaGVtYSMiLA0KICAidW5pdmFyaWF0ZUNvbmZpZ3VyYXRpb25zIjogWw0KICBdDQp9"),
					PayloadType: to.Ptr(anomalydetector.PayloadTypeInlineBase64),
				},
				{
					Path:        to.Ptr(".platform"),
					Payload:     to.Ptr("ZG90UGxhdGZvcm1CYXNlNjRTdHJpbmc="),
					PayloadType: to.Ptr(anomalydetector.PayloadTypeInlineBase64),
				}},
		},
	}

	testsuite.serverFactory.ItemsServer.BeginGetAnomalyDetectorDefinition = func(ctx context.Context, workspaceID string, anomalyDetectorID string, options *anomalydetector.ItemsClientBeginGetAnomalyDetectorDefinitionOptions) (resp azfake.PollerResponder[anomalydetector.ItemsClientGetAnomalyDetectorDefinitionResponse], errResp azfake.ErrorResponder) {
		testsuite.Require().Equal(exampleWorkspaceID, workspaceID)
		testsuite.Require().Equal(exampleAnomalyDetectorID, anomalyDetectorID)
		resp = azfake.PollerResponder[anomalydetector.ItemsClientGetAnomalyDetectorDefinitionResponse]{}
		resp.SetTerminalResponse(http.StatusOK, anomalydetector.ItemsClientGetAnomalyDetectorDefinitionResponse{DefinitionResponse: exampleRes}, nil)
		return
	}

	client := testsuite.clientFactory.NewItemsClient()
	poller, err := client.BeginGetAnomalyDetectorDefinition(ctx, exampleWorkspaceID, exampleAnomalyDetectorID, &anomalydetector.ItemsClientBeginGetAnomalyDetectorDefinitionOptions{Format: nil})
	testsuite.Require().NoError(err, "Failed to get result for example ")
	res, err := poller.PollUntilDone(ctx, nil)
	testsuite.Require().NoError(err, "Failed to get LRO result for example ")
	testsuite.Require().True(reflect.DeepEqual(exampleRes, res.DefinitionResponse))
}

func (testsuite *FakeTestSuite) TestItems_UpdateAnomalyDetectorDefinition() {
	// From example
	ctx := runtime.WithHTTPHeader(testsuite.ctx, map[string][]string{
		"example-id": {"Update a AnomalyDetector definition example"},
	})
	var exampleWorkspaceID string
	var exampleAnomalyDetectorID string
	var exampleUpdateAnomalyDetectorDefinitionRequest anomalydetector.UpdateAnomalyDetectorDefinitionRequest
	exampleWorkspaceID = "cfafbeb1-8037-4d0c-896e-a46fb27ff229"
	exampleAnomalyDetectorID = "5b218778-e7a5-4d73-8187-f10824047715"
	exampleUpdateAnomalyDetectorDefinitionRequest = anomalydetector.UpdateAnomalyDetectorDefinitionRequest{
		Definition: &anomalydetector.Definition{
			Format: to.Ptr(anomalydetector.DefinitionFormatAnomalyDetectorV1),
			Parts: []anomalydetector.DefinitionPart{
				{
					Path:        to.Ptr("Configurations.json"),
					Payload:     to.Ptr("eyANCiAgIiRpZCI6ICJodHRwczovL2RldmVsb3Blci5taWNyb3NvZnQuY29tL2pzb24tc2NoZW1hcy9mYWJyaWMvaXRlbS9hbm9tYWx5RGV0ZWN0b3IvZGVmaW5pdGlvbi8xLjAuMC9zY2hlbWEuanNvbiIsDQogICIkc2NoZW1hIjogImh0dHBzOi8vanNvbi1zY2hlbWEub3JnL2RyYWZ0LTA3L3NjaGVtYSMiLA0KICAidW5pdmFyaWF0ZUNvbmZpZ3VyYXRpb25zIjogWw0KICBdDQp9"),
					PayloadType: to.Ptr(anomalydetector.PayloadTypeInlineBase64),
				},
				{
					Path:        to.Ptr(".platform"),
					Payload:     to.Ptr("ZG90UGxhdGZvcm1CYXNlNjRTdHJpbmc="),
					PayloadType: to.Ptr(anomalydetector.PayloadTypeInlineBase64),
				}},
		},
	}

	testsuite.serverFactory.ItemsServer.BeginUpdateAnomalyDetectorDefinition = func(ctx context.Context, workspaceID string, anomalyDetectorID string, updateAnomalyDetectorDefinitionRequest anomalydetector.UpdateAnomalyDetectorDefinitionRequest, options *anomalydetector.ItemsClientBeginUpdateAnomalyDetectorDefinitionOptions) (resp azfake.PollerResponder[anomalydetector.ItemsClientUpdateAnomalyDetectorDefinitionResponse], errResp azfake.ErrorResponder) {
		testsuite.Require().Equal(exampleWorkspaceID, workspaceID)
		testsuite.Require().Equal(exampleAnomalyDetectorID, anomalyDetectorID)
		testsuite.Require().True(reflect.DeepEqual(exampleUpdateAnomalyDetectorDefinitionRequest, updateAnomalyDetectorDefinitionRequest))
		resp = azfake.PollerResponder[anomalydetector.ItemsClientUpdateAnomalyDetectorDefinitionResponse]{}
		resp.SetTerminalResponse(http.StatusOK, anomalydetector.ItemsClientUpdateAnomalyDetectorDefinitionResponse{}, nil)
		return
	}

	client := testsuite.clientFactory.NewItemsClient()
	poller, err := client.BeginUpdateAnomalyDetectorDefinition(ctx, exampleWorkspaceID, exampleAnomalyDetectorID, exampleUpdateAnomalyDetectorDefinitionRequest, &anomalydetector.ItemsClientBeginUpdateAnomalyDetectorDefinitionOptions{UpdateMetadata: to.Ptr(true)})
	testsuite.Require().NoError(err, "Failed to get result for example ")
	_, err = poller.PollUntilDone(ctx, nil)
	testsuite.Require().NoError(err, "Failed to get LRO result for example ")
}
